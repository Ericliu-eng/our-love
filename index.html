<script>
  // ✅ 先定义 appendMsg（必须有）
  function appendMsg(text, align = "left", color = "") {
    const box = document.getElementById("chat-content");
    const div = document.createElement("div");
    div.style.margin = "5px 0";
    div.style.textAlign = align;
    if (color) div.style.color = color;
    div.textContent = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  async function sendToAI() {
    // ✅ 这句是“是否触发”的关键：你点发送一定会看到这条
    appendMsg("[debug] sendToAI triggered", "left", "gray");

    const input = document.getElementById("user-input");
    const msg = input.value.trim();
    if (!msg) return;

    appendMsg(msg, "right");
    input.value = "";

    try {
      const API_URL = "https://our-love-rosy.vercel.app/api/chat";

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            { role: "system", content: "你现在是Z的赛博分身。Z正在睡觉，你负责陪他的对象L聊天。语气要温柔，像真人一样自然。" },
            { role: "user", content: msg }
          ]
        })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        appendMsg(`(API错误 ${res.status}) ${JSON.stringify(data)}`, "left", "gray");
        return;
      }

      const reply =
        data?.choices?.[0]?.message?.content ||
        data?.raw?.candidates?.[0]?.content?.parts?.map(p => p.text).join("") ||
        "(AI没有返回内容)";

      appendMsg(`AI分身: ${reply}`, "left", "#ffb6c1");

    } catch (e) {
      appendMsg(`(前端异常: ${e && e.message ? e.message : e})`, "left", "gray");
    }
  }

  // ✅ 等 DOM 完全就绪再绑定，避免偶发绑定失败
  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("send-btn").addEventListener("click", () => {
      sendToAI();
    });

    document.getElementById("user-input").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendToAI();
      }
    });
  });
</script>
